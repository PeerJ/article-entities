<link rel="import" href="../polymer/polymer.html">

<!--
Element adding links from detected entities.

##### Example

  <article>
    <article-entities></article-entities>
    <section>
      <p>This paragraph contains a <i>Hippopotamus amphibius</i>.</p>
    </section>
  </article>

@element article-entities
@blurb Element adding links from detected entities.
@status alpha
@homepage https://github.com/peerj/article-entities/
-->
<polymer-element name="article-entities">
  <template>
    <style>
    :host {
      width: 275px;
      max-height: 500px;
      overflow-y: auto;
    }
    </style>
    <div id="infobox"></div>
  </template>

  <script>
    Polymer({
      attached: function() {
        this.detectSpecies();
      },

      /**
       * Detect italics in section paragraphs, which are probably species names.
       * Add a link to Wikipedia for each species name.
       */
      detectSpecies: function() {
        var infobox = $(this.$.infobox);
        var infoboxes = {};

        $('article section p').each(function() {
          $('i, em', this).each(function() {
            var node = $(this);

            // exclude if already inside a link
            //if (node.parent('a').length) {
              //return;
            //}

            var text = $.trim(node.text());

            // try to avoid italics that aren't species names
            if (text.length < 5  // too short
              || text.indexOf(' ') === -1 // no space
              || text.indexOf('.') !== -1 // contains a period
              || !/^[A-Z]/.test(text) // doesn't start with a capital letter
              ) {
              return;
            }

            node.css('cursor', 'pointer').on('click', function() {
              var url = 'https://en.wikipedia.org/wiki/Special:Search?' + $.param({ search: text });
              window.open(url);
              return false;
            }).hover(function() {
              node.css('background-color', 'yellow');

              var data = infoboxes[text];

              if (data) {
                infobox.html(data);
                return;
              }

              infoboxes[text] = false;
              infobox.text(text + 'â€¦');

              $.ajax({
                dataType: 'jsonp',
                url: 'https://en.wikipedia.org/w/api.php',
                data: {
                  action: 'query',
                  prop: 'revisions',
                  rvprop: 'content',
                  format: 'json',
                  rvsection: '0',
                  rvparse: '',
                  redirects: '',
                  titles: text
                },
                success: function(data) {
                  var keys = Object.keys(data.query.pages);
                  var content = data.query.pages[keys[0]].revisions[0]['*'];

                  var data = $('.infobox', content).get(0);
                  infoboxes[text] = data;
                  infobox.html(data);
                },
                error: function() {
                  infoboxes[text] = false;
                  infobox.empty();
                }
              });
            }, function() {
              // TODO: cancel loading previous infobox

              node.css('background-color', 'white');
            });
          });
        });
      }
    });
  </script>
</polymer-element>
